#!/usr/bin/env bash

# Use Cadius to install A2D onto an existing file.
# https://github.com/mach-kernel/cadius
#
# Usage:
#
#   INSTALL_IMG=/path/to/hd.2mg INSTALL_PATH=/hd/a2.desktop bin/install

set -e
source "bin/util.sh"

if [ -z "$INSTALL_IMG" ]; then
    cecho red "Variable \$INSTALL_IMG not set, aborting."
    exit 1
fi
if [ -z "$INSTALL_PATH" ]; then
    cecho red "Variable \$INSTALL_PATH not set, aborting."
    exit 1
fi
if ! command -v "cadius" >/dev/null; then
    cecho red "Cadius not installed."
    exit 1
fi

cecho yellow "Installing into image: $INSTALL_IMG at path: $INSTALL_PATH"

tempdir=$(mktemp -d "${TMPDIR:-/tmp}/shk.XXXXXXXXX")
test -d "${tempdir}" || (cecho red "cannot make tempdir"; exit 1)

repeat () {
    if [ $2 -gt 0 ]; then
        for i in $(seq 1 $2); do echo -n "$1"; done
    fi
}

progress () {
    local cur="$1"
    local total="$2"
    local path="$3"

    local w=30
    local l=$(expr $w \* $cur / $total)
    local r=$(expr $w - $l)
    local ls=$(repeat '#' $l)
    local rs=$(repeat ':' $r)

    local cols=$(tput cols)
    local pw=$(expr $cols - $w - 3)
    path="$(echo "$path" | cut -c1-$pw)"

    local reset="$(tput sgr0)"
    local red="$(tput setaf 1)"
    local green="$(tput setaf 2)"

    echo -ne "\r$(tput el)[${green}$ls${red}$rs${reset}] ${green}$path${reset}"
}

# ============================================================
# Implementation for manifest operations

add_file () {
    local disposition="$1"
    local src_file="$2"
    local folder="$3"
    local dst_file="$4"
    local suffix="$5"

    local tmp_file="$tempdir/$dst_file#$suffix"
    current_line=$(expr $current_line + 1)

    # Skip "boot" files when installing to existing image.
    if [ "$disposition" = "boot" ]; then
        return
    fi

    local dst_dir="$INSTALL_PATH"
    if [ "$folder" != "" ]; then
        dst_dir="$INSTALL_PATH/$folder"
    fi

    local tmp_file="$tempdir/$dst_file#$suffix"
    progress $current_line $total_lines "$dst_dir/$dst_file"

    cp "$src_file" "$tmp_file"
    if [ "$suffix" = "040000" ]; then
        perl -p -i -e 's/\r?\n/\r/g' "$tmp_file" # Ensure Apple line endings
    fi

    if [ "$folder" != "" ]; then
        suppress cadius CREATEFOLDER "$INSTALL_IMG" "$dst_dir" --quiet --no-case-bits
    fi
    cadius DELETEFILE "$INSTALL_IMG" "$dst_dir/$dst_file" > /dev/null || true
    suppress cadius ADDFILE "$INSTALL_IMG" "$dst_dir" "$tmp_file" --quiet --no-case-bits
    rm "$tmp_file"
}


# ============================================================
# Install

suppress cadius CREATEFOLDER "$INSTALL_IMG" "$INSTALL_PATH" --quiet --no-case-bits

manifest="$(no_loc_da_names=$INSTALL_NOLOCDA no_sample_media=$INSTALL_NOSAMPLES bin/manifest $@)"
total_lines=$(echo "$manifest" | grep add_file | wc -l)
current_line=0
eval "$manifest"
echo -ne "\r$(tput el)"

rm -rf "${tempdir}"
